name: Build APK from PWA

on:
  repository_dispatch:
    types: [build-apk]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Bubblewrap
        run: npm install -g @bubblewrap/cli

      - name: Initialize and Build TWA
        env:
          PWA_URL: ${{ github.event.client_payload.url }}
          PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
          APP_NAME: ${{ github.event.client_payload.name }}
        run: |
          echo "Initializing TWA for URL: $PWA_URL"
          echo "Package name: $PACKAGE_NAME"
          echo "App name: $APP_NAME"

          # Create a local web manifest.json for the PWA
          # This simulates the PWA's manifest since we can't fetch it
          mkdir -p manifest-server
          cat > manifest-server/manifest.json <<EOF
          {
            "name": "$APP_NAME",
            "short_name": "$APP_NAME",
            "start_url": "/",
            "display": "standalone",
            "theme_color": "#4f46e5",
            "background_color": "#ffffff",
            "icons": [
              {
                "src": "/icon-192.png",
                "sizes": "192x192",
                "type": "image/png"
              },
              {
                "src": "/icon-512.png",
                "sizes": "512x512",
                "type": "image/png"
              }
            ]
          }
          EOF

          echo "Created local manifest.json"
          cat manifest-server/manifest.json

          # Start a simple HTTP server to serve the manifest
          cd manifest-server
          python3 -m http.server 8080 &
          SERVER_PID=$!
          cd ..
          sleep 2

          # Initialize Bubblewrap with the local manifest
          echo "Initializing Bubblewrap..."
          mkdir pwa-project
          cd pwa-project

          # Generate keystore first (before init)
          keytool -genkey -v -keystore android.keystore -alias android -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=PWA2APK Studio, OU=Development, O=PWA2APK, L=Unknown, ST=Unknown, C=US"

          # Run bubblewrap init with all required parameters to avoid interactive prompts
          echo "Running bubblewrap init..."
          yes "" | bubblewrap init --manifest http://localhost:8080/manifest.json || true

          # Kill the HTTP server
          kill $SERVER_PID || true

          # Check if twa-manifest.json was created
          if [ ! -f twa-manifest.json ]; then
            echo "twa-manifest.json not created by init, creating manually..."
            cat > twa-manifest.json <<TWAEOF
          {
            "packageId": "$PACKAGE_NAME",
            "host": "$PWA_URL",
            "name": "$APP_NAME",
            "launcherName": "$APP_NAME",
            "display": "standalone",
            "themeColor": "#4f46e5",
            "navigationColor": "#4f46e5",
            "backgroundColor": "#ffffff",
            "enableNotifications": true,
            "startUrl": "/",
            "iconUrl": "https://via.placeholder.com/512",
            "maskableIconUrl": "https://via.placeholder.com/512",
            "monochromeIconUrl": "https://via.placeholder.com/512",
            "splashScreenFadeOutDuration": 300,
            "signingKey": {
              "path": "./android.keystore",
              "alias": "android"
            },
            "appVersionName": "1.0.0",
            "appVersionCode": 1,
            "shortcuts": [],
            "generatorApp": "pwa2apk-studio",
            "webManifestUrl": "$PWA_URL/manifest.json",
            "fallbackType": "customtabs",
            "features": {},
            "alphaDependencies": {
              "enabled": false
            },
            "enableSiteSettingsShortcut": true,
            "isChromeOSOnly": false,
            "isMetaQuest": false,
            "minSdkVersion": 19,
            "targetSdkVersion": 33
          }
          TWAEOF
          else
            echo "Updating twa-manifest.json..."
            # Update package name and host
            cat twa-manifest.json | \
              sed "s|\"packageId\":.*|\"packageId\": \"$PACKAGE_NAME\",|" | \
              sed "s|\"host\":.*|\"host\": \"$PWA_URL\",|" > twa-manifest.json.tmp
            mv twa-manifest.json.tmp twa-manifest.json
          fi

          echo "Final twa-manifest.json:"
          cat twa-manifest.json

          echo "Building APK with Bubblewrap..."
          bubblewrap build

          echo "Build complete!"
          ls -lah

      - name: List Build Output
        run: |
          echo "Build complete. Listing APK files:"
          find pwa-project -name "*.apk" -type f
          ls -lah pwa-project/

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: |
            pwa-project/app/build/outputs/apk/**/*.apk
            pwa-project/*.apk
          retention-days: 1
          if-no-files-found: warn
