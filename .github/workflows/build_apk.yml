name: Build APK from PWA

on:
  repository_dispatch:
    types: [build-apk]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Bubblewrap
        run: npm install -g @bubblewrap/cli

      - name: Initialize and Build TWA
        env:
          PWA_URL: ${{ github.event.client_payload.url }}
          PACKAGE_NAME: ${{ github.event.client_payload.package_name }}
          APP_NAME: ${{ github.event.client_payload.name }}
        run: |
          echo "Initializing TWA for URL: $PWA_URL"
          echo "Package name: $PACKAGE_NAME"
          echo "App name: $APP_NAME"

          # Install Pillow for icon generation
          pip3 install Pillow

          # Create placeholder icons using Python/Pillow
          mkdir -p manifest-server
          python3 << 'PYSCRIPT'
from PIL import Image, ImageDraw, ImageFont

# Create 192x192 icon
img192 = Image.new('RGB', (192, 192), color='#4f46e5')
draw192 = ImageDraw.Draw(img192)
try:
    font192 = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 48)
except:
    font192 = ImageFont.load_default()
text = "PWA"
bbox = draw192.textbbox((0, 0), text, font=font192)
text_width = bbox[2] - bbox[0]
text_height = bbox[3] - bbox[1]
draw192.text(((192-text_width)/2, (192-text_height)/2), text, fill='white', font=font192)
img192.save('manifest-server/icon-192.png')

# Create 512x512 icon
img512 = Image.new('RGB', (512, 512), color='#4f46e5')
draw512 = ImageDraw.Draw(img512)
try:
    font512 = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf", 128)
except:
    font512 = ImageFont.load_default()
bbox = draw512.textbbox((0, 0), text, font=font512)
text_width = bbox[2] - bbox[0]
text_height = bbox[3] - bbox[1]
draw512.text(((512-text_width)/2, (512-text_height)/2), text, fill='white', font=font512)
img512.save('manifest-server/icon-512.png')

print("Icons created successfully")
PYSCRIPT

          # Create a local web manifest.json for the PWA
          cat > manifest-server/manifest.json <<EOF
          {
            "name": "$APP_NAME",
            "short_name": "$APP_NAME",
            "start_url": "/",
            "display": "standalone",
            "theme_color": "#4f46e5",
            "background_color": "#ffffff",
            "icons": [
              {
                "src": "/icon-192.png",
                "sizes": "192x192",
                "type": "image/png"
              },
              {
                "src": "/icon-512.png",
                "sizes": "512x512",
                "type": "image/png"
              }
            ]
          }
          EOF

          echo "Created local manifest.json and icons"

          # Start a simple HTTP server to serve the manifest and icons
          cd manifest-server
          python3 -m http.server 8080 &
          SERVER_PID=$!
          cd ..
          sleep 3

          # Initialize Bubblewrap with the local manifest
          echo "Initializing Bubblewrap..."
          mkdir pwa-project
          cd pwa-project

          # Generate keystore first (before init)
          keytool -genkey -v -keystore android.keystore -alias android -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=PWA2APK Studio, OU=Development, O=PWA2APK, L=Unknown, ST=Unknown, C=US"

          # Run bubblewrap init with all required parameters to avoid interactive prompts
          echo "Running bubblewrap init..."
          yes "" | bubblewrap init --manifest http://localhost:8080/manifest.json || true

          # Kill the HTTP server
          kill $SERVER_PID || true

          # Update twa-manifest.json with correct values
          if [ -f twa-manifest.json ]; then
            echo "Updating twa-manifest.json..."
            # Update package name and host
            cat twa-manifest.json | \
              sed "s|\"packageId\":.*|\"packageId\": \"$PACKAGE_NAME\",|" | \
              sed "s|\"host\":.*|\"host\": \"$PWA_URL\",|" > twa-manifest.json.tmp
            mv twa-manifest.json.tmp twa-manifest.json

            echo "Final twa-manifest.json:"
            cat twa-manifest.json
          else
            echo "ERROR: twa-manifest.json was not created by bubblewrap init"
            exit 1
          fi

          echo "Building APK with Bubblewrap..."
          bubblewrap build

          echo "Build complete!"
          ls -lah

      - name: List Build Output
        run: |
          echo "Build complete. Listing APK files:"
          find pwa-project -name "*.apk" -type f
          ls -lah pwa-project/

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: |
            pwa-project/app/build/outputs/apk/**/*.apk
            pwa-project/*.apk
          retention-days: 1
          if-no-files-found: warn
